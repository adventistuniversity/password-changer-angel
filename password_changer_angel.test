<?php
// $Id: password_changer_angel.test,v 0.1 2011/03/22 23:28:11 arod Exp $

/**
 * @file
 * Test case for Testing the page example module.
 *
 * This file contains the test cases to check if module is performing as
 * expected.
 *
 */
//Include files

//Installing module if I can use the 


//Extends DrupalWebTestCase to get database connection
class PasswordChangerAngelAdminCase extends DrupalWebTestCase  {


  public static function getInfo() {
    return array(
      'name' => 'Angel Password Changer Submodule - Configuration',
      'description' => 'Test password changer configuration pages for Angel.',
      'group' => 'Password Changer',
    );
  }
  
  function setUp() {
    parent::setUp('password_changer_api', 'password_changer_angel');
    
     //Create user and login
    $this->admin_user = $this->drupalCreateUser(array('access administration pages','administer password changer'));
    $this->drupalLogin($this->admin_user);

  }
  
    // Test Case 1.1 
  function testPasswordChangerAngelAccessHelp() {
   
  
    //Access help page
    $this->drupalGet('admin/help/password_changer_angel');
    $this->assertResponse(200, t('Access help page successfully.'));
    $this->assertText(t('Password Changer for Angel'), t('Page title is Password Changer for Angel'));
    
  }

  // Test Case 1.2
  function testPasswordChangerAngelAccessConfiguration() {
    
    //Access configuration page
    $this->drupalGet('admin/config/password_changer/password_changer_angel');
    $this->assertResponse(200, t('Access registration page successfully.'));
    $this->assertText(t('Password Changer Angel Settings'), t('Page title is Password Changer Angel Settings'));
    
  }
  
  //Test Case 1.3
  function testPasswordChangerAngelAddSettings() {
    
    //Create role
    $this->drupalPost('admin/config/password_changer/password_changer_angel',
                       array('api_username' => 'test_admin',
                             'api_password' => 'password_api',
                             'api_url' => 'http://fhcvm-angel/api/default.asp' ),
                       
                       t('Save Settings'));
    
    $this->assertText('Your Angel API settings have been saved', 'Message Found: Your Angel API settings have been saved.');
    
    //Test Case 1.4
    $this->drupalPost('admin/config/password_changer/password_changer_angel',
                        array('api_username' => '',
                              'api_password' => '',
                              'api_url' => '' ), t('Save Settings'));
    
    $this->assertNoText('Your Angel API settings have been saved','Message Not Found: Your Angel API settings have been saved');
    
  }

}


//Extends DrupalWebTestCase to get database connection
class PasswordChangerAngelUserCase extends DrupalWebTestCase  {


  public static function getInfo() {
    return array(
      'name' => 'Angel Password Changer Submodule - User Change Password',
      'description' => 'Test Angel password changer from the user perspective, change password.',
      'group' => 'Password Changer',
    );
  }
  //Including modules that needed for the test case
  function setUp() {
    parent::setUp('password_changer_api', 'password_changer_angel');
    
    
    //Create admin with access to admin pages
    $this->admin_user = $this->drupalCreateUser(array('administer password changer'));
    
    $this->drupalLogin($this->admin_user);
      
    //Settings
    $this->drupalPost('admin/config/password_changer/password_changer_angel',
                       array('api_username' => 'api_admin',
                             'api_password' => 'S@chm0Bl0Ws',
                             'api_url' => 'http://fhcvm-angel/api/default.asp' ),
                       
                       t('Save Settings'));
    
    $this->assertText('Your Angel API settings have been saved.', 'Message Found: Your Angel API settings have been saved.');
    
    $this->drupalLogout();
     
    
  }
  
  function testPasswordChangerAngelUserChangePassword() {
    
    //Test Case 2.1
    //Create another user withtout an account in angel test server.
    $this->another_user = $this->drupalCreateUser();    
    
    $this->assertTrue(!empty($this->another_user->uid), t('User created with name %name has been created.', array('%name' => $this->another_user->name)), t('User login'));
    
    $this->drupalLogin($this->another_user);
    
    $this->drupalGet('user/' . $this->another_user->uid . '/edit');
    $this->assertResponse(200, t('Able to reach the user %name and  profile page.', array('%name' => $this->another_user->name)));
    $this->assertNoText('Angel Learning System','Option to change Angel password appears in the user profile page.');
    
    $this->drupalLogout();

    //Test Case 2.2
    //Create student user
    $rid = $this->drupalCreateRole(array('access comments', 'access content', 'post comments', 'change own username'),
                                       'UNIVERSAL STUDENTS');
  
    //Set user values
    $edit['name']   = 'student1testserver';
    $edit['mail']   = 'student1testserver' . '@example.com';
    $edit['roles']  = array($rid => $rid);
    $edit['pass']   = 'test34';
    $edit['status'] = 1;
    //Creat user
    $account = user_save('', $edit);
    $account->pass_raw = $edit['pass'];
    $this->student_test = $account;   
    
    $this->assertTrue(!empty($account->uid), t('User created with name %name and pass %pass', array('%name' => $edit['name'], '%pass' => $edit['pass'])), t('User login'));
    
    
    $this->drupalLogin($this->student_test);
    
    $this->drupalGet('user/' . $this->student_test->uid . '/edit');
    $this->assertResponse(200, t('Able to reach the user %name and  profile page.', array('%name' => $this->student_test->name)));
    $this->assertText('Angel Learning System','Option to change Angel password appears in the user profile page.');
    
    $this->drupalLogout();

    //Test Case 2.3
    $this->drupalLogin($this->student_test);
    
    $this->drupalGet('user/' . $this->student_test->uid . '/edit');
    $this->assertResponse(200, t('Able to reach the user %name and  profile page.', array('%name' => $this->student_test->name)));
    //Change password
    $this->drupalPost('user/' . $this->student_test->uid . '/edit', array('current_pass' => 'test34',
                                                                        'pass[pass1]' => 'test12', 'pass[pass2]' => 'test12'),t('Save'));
    
    $this->student_test->pass_raw = 'test12';
    
    $this->assertText('Password has been changed in your Angel account', 'Password has been change successfuly in Angel Account');
        
  
    //Logout
    $this->drupalLogout(); 
  }
  
}




